<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ZERON FREE AGENT - Takım Rezervasyon Sistemi</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Firebase SDKs: Auth ve Firestore -->
    <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js"></script>
    
    <style>
        /* Özel Tema Stilleri */
        :root {
            --bg-dark: #1a1a2e; 
            --primary-red: #e94560; 
            --accent-light: #f1f1f1; 
            --card-dark: #24243e; 
            --card-active: #3f3f6e;
            --modal-bg-light: #ffffff; 
            --text-dark: #1f2937; /* Koyu metin rengi (yaklaşık siyah) */
        }

        body {
            background-color: var(--bg-dark);
            color: var(--accent-light); 
            font-family: 'Inter', sans-serif;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        /* Başlık Stili */
        #title {
            text-shadow: 0 0 10px var(--primary-red);
        }

        /* Rezervasyon Kutucukları (Slots) */
        .slot-card {
            background-color: var(--card-dark);
            transition: transform 0.2s, box-shadow 0.2s;
            border: 1px solid var(--primary-red);
            min-height: 200px; 
            height: auto; 
            position: relative; 
        }

        .slot-card.reserved {
            cursor: default;
        }

        .slot-card.clickable:hover {
            background-color: var(--card-active);
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(233, 69, 96, 0.3);
        }
        
        /* Düğmeler */
        #save-button, .modal-button {
            transition: background-color 0.2s, transform 0.1s;
        }
        .modal-button:hover {
            transform: translateY(-1px);
        }

        /* Modal (Popup) Arka Planı */
        .modal-overlay {
            background-color: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(4px);
            overflow-y: auto; 
        }
        
        /* Liste İkonu Rengi (Kural Kutucuğu) */
        .rule-list li::before {
            content: "•";
            color: var(--primary-red);
            font-weight: bold;
            display: inline-block; 
            width: 1em;
            margin-left: -1em;
        }
        
        /* MODAL İÇİ ÖZEL STİLLER */
        .modal-content-area {
            background-color: var(--modal-bg-light); 
            color: var(--text-dark); 
            max-height: 90vh; 
            display: flex; 
            flex-direction: column;
        }

        /* Sadece Formun Kaydırılabilir Alanı */
        .modal-scroll-area {
            overflow-y: auto;
            flex-grow: 1; 
            padding-bottom: 0.5rem; 
        }
        
        /* Modal Input Alanları */
        .modal-input {
            background-color: #f3f4f6; 
            color: var(--text-dark); 
            border: 1px solid #d1d5db;
        }
        .modal-input:focus {
            border-color: var(--primary-red);
            box-shadow: 0 0 0 1px var(--primary-red);
        }
        
        /* İptal Butonu Stili (Kartın Dışında, Üstte) */
        .cancel-button {
            display: flex; 
            align-items: center;
            justify-content: center;
            width: fit-content; 
            margin: 0 auto 8px auto; 
            
            background-color: var(--primary-red);
            color: white;
            font-size: 0.8rem; 
            font-weight: bold;
            padding: 6px 12px; 
            border-radius: 9999px; 
            cursor: pointer;
            transition: background-color 0.15s, transform 0.15s, box-shadow 0.15s;
            
            gap: 6px;
            z-index: 10;
            border: none;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.3);
            white-space: nowrap; 
        }
        .cancel-button:hover {
            background-color: #ff6384; 
            transform: scale(1.05);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.5);
        }
        
    </style>
</head>
<body class="selection:bg-red-500 selection:text-white">

    <!-- Üst Başlık ve Saat Alanı -->
    <header class="bg-black/20 p-4 flex flex-col sm:flex-row justify-between items-center border-b-2 border-primary-red shadow-lg">
        <div id="title" class="text-3xl sm:text-4xl font-extrabold text-white tracking-wider mb-2 sm:mb-0">
            ZERON ORGANİZASYON
        </div>
        <div id="datetime" class="text-sm sm:text-lg font-medium text-gray-300 text-center sm:text-right">
            <!-- Canlı Saat Buraya Gelecek -->
        </div>
    </header>

    <!-- Ana İçerik -->
    <main class="flex-grow p-4 sm:p-8">
        <h1 class="text-2xl sm:text-3xl font-bold text-center mt-6 mb-8 text-primary-red tracking-wide">
            OYUNCUYA İHTİYACI OLAN TAKIMLAR
        </h1>
        
        <!-- Bilgilendirme Kutucuğu -->
        <div class="max-w-6xl mx-auto p-4 mb-8 bg-card-dark rounded-xl border border-primary-red shadow-lg">
            <h2 class="text-xl font-bold mb-2 text-primary-red">REZERVASYON KURALLARI VE BİLGİLENDİRME</h2>
            <ul class="text-sm space-y-1 rule-list ml-4">
                <li><span class="text-gray-300">Rezervasyonlar **Firestore** ile kalıcı olarak kaydedilir ve **canlı olarak** herkes tarafından görülür.</span></li>
                <li><span class="text-gray-300">Herkes sadece günde **bir kez** rezervasyon yapabilir (Limit tarayıcı bazlıdır).</span></li>
                <li><span class="text-gray-300">Boş bir slota tıklayarak kolayca rezervasyon yapabilirsiniz.</span></li>
            </ul>
        </div>
        
        <!-- Yükleniyor Mesajı -->
        <div id="loading-indicator" class="text-center text-lg text-gray-400 mt-10">
            Sistem başlatılıyor ve yetkilendirme bekleniyor...
        </div>

        <!-- Rezervasyon Kutucukları (Grid) -->
        <div id="slots-container" class="max-w-6xl mx-auto grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 hidden">
            <!-- Kutucuklar JavaScript ile doldurulacak -->
        </div>
    </main>
    
    <!-- YÖNETİCİ PANELİ KONTEYNERİ (Admin Aktif Olunca Görünür) -->
    <div id="admin-panel-container" class="w-full flex justify-center p-4 hidden">
        <div id="admin-panel" class="bg-card-active p-4 rounded-lg border border-primary-red shadow-xl w-full max-w-xl text-center">
            <h3 class="text-xl font-bold text-primary-red mb-2">⚙️ YÖNETİCİ MODU AKTİF</h3>
            <p class="text-sm mb-0">Rezerve slotların üzerindeki **"SLOTU İPTAL ET"** tuşuna tıkladığınızda, **anında ve onaysız** silinir.</p>
        </div>
    </div>
    
    <!-- Alt Bilgi (Footer) -->
    <footer class="bg-black/20 text-center p-4 border-t-2 border-primary-red mt-auto">
        <p class="text-sm font-light">
            Instagram adresimiz: 
            <a href="https://instagram.com/zeronorg" target="_blank" class="text-primary-red hover:underline font-bold">
                @ZERONORG
            </a>
        </p>
        <p id="user-info" class="text-xs text-gray-500 mt-1">Kullanıcı ID: Yükleniyor...</p>
    </footer>


    <!-- Rezervasyon Formu MODAL (Popup) -->
    <div id="reservation-modal" class="modal-overlay fixed inset-0 z-50 flex items-center justify-center p-4 hidden">
        <div class="modal-content-area p-6 sm:p-8 rounded-xl shadow-2xl w-full max-w-md border-2 border-primary-red">
            <h2 id="modal-title" class="text-2xl font-bold mb-6 text-center text-primary-red">SLOT REZERVASYON</h2>
            
            <div class="modal-scroll-area">
                <form id="reservation-form" class="space-y-4">
                    <input type="hidden" id="slot-id-input" name="slotId">
                    
                    <!-- Takım Adı -->
                    <div>
                        <label for="team-name" class="block text-sm font-medium mb-1">Takım Adı <span class="text-red-500">*</span></label>
                        <input type="text" id="team-name" name="teamName" required 
                               maxlength="50"
                               class="modal-input w-full p-3 rounded-lg focus:outline-none focus:ring-2" 
                               placeholder="Takımınızın Adını Girin">
                    </div>
                    
                    <!-- Instagram Adı -->
                    <div>
                        <label for="instagram" class="block text-sm font-medium mb-1">Instagram Kullanıcı Adı (Örn: @zeronorg) <span class="text-red-500">*</span></label>
                        <input type="text" id="instagram" name="instagram" required 
                               maxlength="30"
                               class="modal-input w-full p-3 rounded-lg focus:outline-none focus:ring-2" 
                               placeholder="@KullanıcıAdı">
                    </div>
                    
                    <!-- Açıklama -->
                    <div>
                        <label for="description" class="block text-sm font-medium mb-1">Açıklama</label>
                        <textarea id="description" name="description" rows="4" 
                                  class="modal-input w-full p-3 rounded-lg focus:outline-none focus:ring-2 resize-none" 
                                  placeholder="Hangi oyuncu ihtiyacınız var?"></textarea>
                    </div>
                    
                    <!-- Hata Mesajı Alanı -->
                    <p id="form-error-message" class="text-sm font-semibold text-red-600 hidden"></p>
                </form>
            </div>
            
            <!-- Butonlar -->
            <div class="mt-6 flex justify-between space-x-4">
                <!-- İPTAL BUTONU (Yazı Rengi Zaten Koyu) -->
                <button type="button" id="cancel-modal-button" 
                        class="modal-button flex-1 py-3 bg-gray-300 text-text-dark font-bold rounded-xl shadow-md hover:bg-gray-400">
                    İPTAL
                </button>
                <!-- REZERVE ET BUTONU (Yazı Rengi Siyah olarak güncellendi) -->
                <button type="submit" form="reservation-form" id="save-button" 
                        class="modal-button flex-1 py-3 bg-primary-red text-black font-bold rounded-xl shadow-md hover:bg-red-600">
                    REZERVE ET
                </button>
            </div>
        </div>
    </div>
    
    <!-- Toast Mesaj Alanı -->
    <div id="toast-container" class="fixed top-4 right-4 z-50 space-y-2">
        <!-- Toast mesajları buraya gelecek -->
    </div>


<script type="module">
    // Firebase Imports
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, signInAnonymously, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { 
        getFirestore, doc, setDoc, deleteDoc, collection, query, onSnapshot, setLogLevel
    } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    // --- Global Variables (Canvas tarafından sağlanır) ---
    const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
    const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' && __firebase_config ? __firebase_config : '{}');
    const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null; 

    // --- Firebase Service References ---
    let app = null;
    let db = null;
    let auth = null;
    let userId = null;
    let isAdmin = false; 

    // --- Yetkilendirme Promise'ı (Kodun Firestore'a erişmeden önce Auth'u beklemesi için) ---
    let resolveAuthReady;
    const authReadyPromise = new Promise(resolve => {
        resolveAuthReady = resolve;
    });


    // --- Firebase Başlatma ve Yetkilendirme Akışı ---
    async function initializeFirebase() {
        if (!Object.keys(firebaseConfig).length) {
            console.error("KRİTİK HATA: Firebase yapılandırması eksik.");
            document.getElementById('loading-indicator').textContent = 'HATA: Firebase yapılandırması yüklenemedi.';
            resolveAuthReady(); // Yetkilendirme başarısız da olsa promise'i çöz
            return;
        }

        try {
            // Detaylı hata mesajları için
            setLogLevel('Debug');
            
            // 1. SERVİSLERİ BAŞLAT
            app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);
            
            // 2. YETKİLENDİRME SÜRECİ
            let success = false;

            if (initialAuthToken) {
                // ÖNCE ADMIN GİRİŞİNİ DENEYELİM (Token varsa)
                try {
                    await signInWithCustomToken(auth, initialAuthToken);
                    isAdmin = true;
                    success = true;
                    console.log("INFO: YÖNETİCİ MODU AKTİF. Custom Token ile giriş başarılı.");
                } catch (error) {
                    // Yönetici girişi başarısız olursa (Büyük olasılıkla izin hatası budur)
                    console.warn(`UYARI: Yönetici tokenı ile giriş başarısız. Hata kodu: ${error.code}. Anonim Girişe geçiliyor...`);
                }
            }

            // Admin girişi başarısız olduysa veya token yoksa anonim giriş yap
            if (!success) {
                try {
                    await signInAnonymously(auth);
                    isAdmin = false;
                    success = true;
                    console.log("INFO: Anonim olarak giriş yapıldı.");
                } catch (error) {
                    console.error("KRİTİK HATA: Anonim Giriş de başarısız oldu. Hata kodu:", error.code);
                    document.getElementById('loading-indicator').textContent = `KRİTİK HATA: Oturum açılamadı. Hata: ${error.code}. Kuralları kontrol edin.`;
                    resolveAuthReady();
                    return;
                }
            }

            // Girişin başarılı olduğundan emin olduktan sonra bilgileri al ve promise'i çöz
            userId = auth.currentUser?.uid || crypto.randomUUID(); // Fallback ID
            console.log(`INFO: Oturum Açma Tamamlandı. Final Kullanıcı ID: ${userId}, Yönetici: ${isAdmin}`);
            
            updateUIOnAuthReady();
            // Auth tamamlandıktan sonra veri dinlemeyi başlat
            startListeningForSlots(); 
            
            resolveAuthReady(); 

        } catch (error) {
            console.error("KRİTİK HATA: Uygulama başlatma sırasında beklenmedik bir hata oluştu:", error);
            document.getElementById('loading-indicator').textContent = `KRİTİK HATA: Sistem başlatılamadı. Konsolu kontrol edin.`;
            resolveAuthReady();
        }
    }
    
    /**
     * Yetkilendirme sonrası UI güncellemeleri
     */
    function updateUIOnAuthReady() {
        document.getElementById('loading-indicator').classList.add('hidden');
        document.getElementById('slots-container').classList.remove('hidden');
        document.getElementById('user-info').textContent = `Kullanıcı ID: ${userId || 'Anonim (Hata)'}`;
        
        // Yönetici ise paneli göster
        if (isAdmin) {
            // Buradaki 'hidden' sınıfını kaldırarak paneli gösteriyoruz
            document.getElementById('admin-panel-container').classList.remove('hidden');
        } else {
            document.getElementById('admin-panel-container').classList.add('hidden');
        }
    }

    // Uygulama yüklendiğinde Firebase'i başlat
    initializeFirebase();


    // --- Yardımcı Fonksiyonlar ---
    
    /**
     * Firestore koleksiyon yolu (public)
     */
    function getSlotsCollectionRef() {
        if (!db) {
            return null;
        }
        // Güvenlik kurallarında açtığımız public yol:
        return collection(db, `artifacts/${appId}/public/data/slots`);
    }

    /**
     * Toast mesajı gösterir (bildirim)
     */
    function showToast(message, type = 'info') {
        const toastContainer = document.getElementById('toast-container');
        const toast = document.createElement('div');
        
        let bgColor = '';
        let icon = '';

        switch (type) {
            case 'success':
                bgColor = 'bg-green-500';
                icon = '✅';
                break;
            case 'error':
                bgColor = 'bg-red-500';
                icon = '❌';
                break;
            case 'info':
            default:
                bgColor = 'bg-blue-500';
                icon = 'ℹ️';
                break;
        }

        toast.className = `p-4 rounded-lg shadow-xl text-white ${bgColor} flex items-center space-x-2 animate-fade-in-down`;
        toast.innerHTML = `
            <span class="text-xl">${icon}</span>
            <p class="font-semibold">${message}</p>
        `;
        
        toastContainer.appendChild(toast);

        // 5 saniye sonra kaldır
        setTimeout(() => {
            // Toast'ı kaldırırken animasyon kullan
            toast.classList.add('animate-fade-out-up');
            setTimeout(() => toast.remove(), 500); 
        }, 5000);
        
        // Animasyon stillerini bir kez ekle
        if (!document.querySelector('style[data-toast-styles]')) {
            const style = document.createElement('style');
            style.setAttribute('data-toast-styles', 'true');
            style.innerHTML = `
                @keyframes fadeInDown {
                    from { opacity: 0; transform: translateY(-20px); }
                    to { opacity: 1; transform: translateY(0); }
                }
                @keyframes fadeOutUp {
                    from { opacity: 1; transform: translateY(0); }
                    to { opacity: 0; transform: translateY(-20px); }
                }
                .animate-fade-in-down { animation: fadeInDown 0.3s ease-out forwards; }
                .animate-fade-out-up { animation: fadeOutUp 0.3s ease-in forwards; }
            `;
            document.head.appendChild(style);
        }
    }
    
    /**
     * Tarih ve saati Türkiye Saati (TSİ) olarak günceller
     */
    function updateDateTime() {
        const dtElement = document.getElementById('datetime');
        const now = new Date();
        
        const dateOptions = { 
            weekday: 'long', 
            year: 'numeric', 
            month: 'long', 
            day: 'numeric',
            timeZone: 'Europe/Istanbul'
        };
        const timeOptions = { 
            hour: '2-digit', 
            minute: '2-digit', 
            second: '2-digit',
            timeZone: 'Europe/Istanbul'
        };

        const dateStr = now.toLocaleDateString('tr-TR', dateOptions);
        const timeStr = now.toLocaleTimeString('tr-TR', timeOptions);

        dtElement.innerHTML = `${dateStr} <br class="sm:hidden"> ${timeStr} TSİ`;
    }
    
    // TSİ'yi hemen başlat ve saniyede bir güncelle
    setInterval(updateDateTime, 1000);
    updateDateTime(); 

    /**
     * Yerel depolama kullanarak kullanıcının bugün rezervasyon yapıp yapmadığını kontrol eder.
     */
    function hasUserReservedToday() {
        const today = new Date().toLocaleDateString('tr-TR', { timeZone: 'Europe/Istanbul' });
        const lastReservationDate = localStorage.getItem('lastReservationDate');
        return lastReservationDate === today;
    }

    /**
     * Kullanıcının bugünkü rezervasyonunu kaydeder.
     */
    function recordReservation() {
        const today = new Date().toLocaleDateString('tr-TR', { timeZone: 'Europe/Istanbul' });
        localStorage.setItem('lastReservationDate', today);
    }

    /**
     * Firestore'dan slotları dinlemeye başlar (onSnapshot)
     */
    function startListeningForSlots() {
        const slotsRef = getSlotsCollectionRef();
        if (!slotsRef) return; 
        
        const slotsQuery = query(slotsRef);

        // Canlı veri dinlemesi
        onSnapshot(slotsQuery, (snapshot) => {
            const slotsData = {};
            snapshot.forEach(doc => {
                slotsData[doc.id] = doc.data(); 
            });
            renderSlots(slotsData);
        }, (error) => {
            // HATA YAKALAMA: İzin hatası burada yakalanır
            console.error("KRİTİK HATA: Firestore dinleme hatası (Yetki Kontrolü):", error);
            showToast(`Hata: Veri yüklenemedi. Yetki hatası: ${error.code}.`, 'error');
            
            if (error.code === 'permission-denied') {
                document.getElementById('loading-indicator').classList.remove('hidden');
                document.getElementById('loading-indicator').textContent = 'KRİTİK YETKİ HATASI: Firebase Güvenlik Kurallarınızı (Security Rules) LÜTFEN kontrol edin ve "allow read, write: if true;" olarak güncelleyin.';
                document.getElementById('slots-container').classList.add('hidden');
            }
        });
    }

    /**
     * Slot verilerine göre UI'ı günceller
     */
    function renderSlots(slotsData) {
        const container = document.getElementById('slots-container');
        container.innerHTML = '';
        const numSlots = 10; 

        for (let i = 1; i <= numSlots; i++) {
            const slotId = `slot${i}`;
            const slot = slotsData[slotId];
            const isReserved = slot && slot.teamName; 
            
            const card = document.createElement('div');
            card.id = slotId;
            const isReservedClass = isReserved ? 'reserved' : 'clickable cursor-pointer'; 
            card.className = `slot-card p-4 rounded-xl shadow-lg flex flex-col justify-between ${isReservedClass}`;
            card.setAttribute('data-slot-id', slotId);

            let adminButtonHTML = '';
            
            if (isReserved) {
                // REZERVE EDİLMİŞ DURUM
                
                // Eğer kullanıcı yönetici ise iptal butonunu göster
                if (isAdmin) {
                    adminButtonHTML = `
                        <button type="button" class="cancel-button mb-3 bg-red-700 hover:bg-red-800" data-action="cancel" data-slot-id-to-cancel="${slotId}">
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-4 h-4">
                              <path stroke-linecap="round" stroke-linejoin="round" d="M14.74 9l-.346 9m-4.788 0L9.26 9m9.968-3.21c.342.052.682.107 1.022.166m-1.022-.165L18.16 19.673a2.25 2.25 0 01-2.244 2.077H8.084a2.25 2.25 0 01-2.244-2.077L4.24 6.442m5.714 0V3.53a2.25 2.25 0 012.25-2.25h3.375a2.25 2.25 0 012.25 2.25v2.912m-6.83 0h5.106" />
                            </svg>
                            SLOTU İPTAL ET (ADMİN)
                        </button>
                    `;
                }
                
                card.innerHTML = `
                    ${adminButtonHTML}
                    <h3 class="text-xl sm:text-2xl font-extrabold text-primary-red mb-2 uppercase break-words">
                        ${slot.teamName || 'BİLİNMİYOR'}
                    </h3>
                    <p class="text-sm text-gray-400 mb-2 whitespace-pre-wrap">${slot.description || 'Açıklama yok.'}</p>
                    <div class="mt-auto flex justify-between items-center text-sm font-medium pt-2 border-t border-primary-red/50">
                        <span class="text-gray-300">@${slot.instagram || 'Yok'}</span>
                        <span class="text-green-400">REZERVE EDİLDİ</span>
                    </div>
                `;
                
                // Yönetici butonuna event listener ekle
                if (isAdmin) {
                    const cancelButton = card.querySelector('[data-action="cancel"]');
                    if (cancelButton) {
                        cancelButton.addEventListener('click', (e) => {
                            e.stopPropagation(); 
                            cancelReservation(slotId);
                        });
                    }
                }

            } else {
                // BOŞ DURUM
                card.innerHTML = `
                    <h3 class="text-2xl font-extrabold text-white mb-2">SLOT ${i}</h3>
                    <p class="text-sm text-gray-400">TIKLAYARAK REZERVE ET</p>
                    <div class="mt-auto pt-2 border-t border-primary-red/50">
                        <span class="text-green-400 font-bold">BOŞ - Hemen Kap!</span>
                    </div>
                `;
                // Sadece boş slotlara tıklama olayını ekle
                card.onclick = () => openReservationModal(slotId);
            }

            container.appendChild(card);
        }
    }

    // --- Modal Yönetimi ---
    const modal = document.getElementById('reservation-modal');
    const form = document.getElementById('reservation-form');
    const slotIdInput = document.getElementById('slot-id-input');
    const modalTitle = document.getElementById('modal-title');
    const formErrorMessage = document.getElementById('form-error-message');

    /**
     * Rezervasyon modalını açar
     */
    async function openReservationModal(slotId) {
        // Auth işleminin tamamlandığından emin ol
        await authReadyPromise; 

        if (hasUserReservedToday()) {
            showToast('Uyarı: Günlük rezervasyon limitinizi doldurdunuz.', 'info');
            return;
        }

        slotIdInput.value = slotId;
        modalTitle.textContent = `${slotId.toUpperCase()} REZERVASYON`;
        formErrorMessage.classList.add('hidden');
        form.reset();
        modal.classList.remove('hidden');
    }

    /**
     * Rezervasyon modalını kapatır
     */
    function closeReservationModal() {
        modal.classList.add('hidden');
    }

    // Modal Kapatma Butonu
    document.getElementById('cancel-modal-button').onclick = closeReservationModal;
    
    // Modal dışına tıklayarak kapatma
    modal.addEventListener('click', (e) => {
        if (e.target.id === 'reservation-modal') {
            closeReservationModal();
        }
    });


    // --- Rezervasyon Kayıt İşlemi ---

    form.addEventListener('submit', async (e) => {
        e.preventDefault();
        
        // Auth işleminin tamamlandığından emin ol
        await authReadyPromise;
        
        formErrorMessage.classList.add('hidden');
        formErrorMessage.textContent = '';
        
        const saveButton = document.getElementById('save-button');
        saveButton.disabled = true;
        saveButton.textContent = 'Kaydediliyor...';
        
        const slotId = slotIdInput.value;
        const teamName = document.getElementById('team-name').value.trim();
        const instagram = document.getElementById('instagram').value.trim().replace(/^@/, ''); 
        const description = document.getElementById('description').value.trim();

        if (!teamName || !instagram) {
            formErrorMessage.textContent = 'Lütfen Takım Adı ve Instagram alanlarını doldurun.';
            formErrorMessage.classList.remove('hidden');
            saveButton.disabled = false;
            saveButton.textContent = 'REZERVE ET';
            return;
        }

        if (hasUserReservedToday()) {
            formErrorMessage.textContent = 'Hata: Günlük rezervasyon limitinizi doldurdunuz.';
            formErrorMessage.classList.remove('hidden');
            saveButton.disabled = false;
            saveButton.textContent = 'REZERVE ET';
            return;
        }
        
        const updatedSlot = {
            teamName: teamName,
            instagram: instagram,
            description: description,
            userId: userId, 
            timestamp: Date.now()
        };

        try {
            const slotsRef = getSlotsCollectionRef();
            if (!slotsRef) throw new Error("Firestore referansı bulunamıyor.");

            const slotDocRef = doc(slotsRef, slotId);
            await setDoc(slotDocRef, updatedSlot);

            // Başarılı olursa
            recordReservation(); 
            closeReservationModal();
            showToast(`${slotId.toUpperCase()} başarıyla rezerve edildi!`, 'success');

        } catch (error) {
            console.error("Rezervasyon kaydetme hatası:", error);
            
            let userFriendlyError = `HATA: Kaydedilemedi. (${error.code}). Detaylar konsolda.`;
            if (error.code === 'permission-denied') {
                 userFriendlyError = 'KRİTİK HATA: Veri tabanı izinleri yetersiz. Güvenlik Kurallarını kontrol edin!';
            } 

            formErrorMessage.textContent = userFriendlyError;
            formErrorMessage.classList.remove('hidden');
            showToast(userFriendlyError, 'error');
            
        } finally {
            saveButton.disabled = false;
            saveButton.textContent = 'REZERVE ET';
        }
    });
    
    /**
     * Yöneticiler için slot iptali
     */
    async function cancelReservation(slotId) {
        if (!isAdmin) {
            showToast('Yetkisiz işlem! Bu eylem sadece yöneticiler için geçerlidir.', 'error');
            return;
        }
        
        try {
            await authReadyPromise;
            const slotsRef = getSlotsCollectionRef();
            if (!slotsRef) throw new Error("Firestore referansı bulunamıyor.");

            const slotDocRef = doc(slotsRef, slotId);
            await deleteDoc(slotDocRef);
            
            showToast(`${slotId.toUpperCase()} yönetici tarafından başarıyla iptal edildi.`, 'success');

        } catch (error) {
            console.error("Rezervasyon iptal etme hatası:", error);
            showToast(`İptal Hatası: ${error.code}. Kurallarınızı kontrol edin.`, 'error');
        }
    }
    
</script>
</body>
</html>
