<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ZERON ORGANİZASYON - Takım Rezervasyon Sistemi</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #111827; /* Çok Koyu Siyahımsı Arka Plan */
            color: #ffffff;
            line-height: 1.6;
        }
        /* Yeni Koyu Tema Renkleri */
        .text-custom-red { color: #ef4444; } /* Vurgu: Canlı Kırmızı */
        .border-custom-red { border-color: #ef4444; }
        .bg-custom-red-light { background-color: #ef444420; }
        .text-custom-green { color: #10b981; } /* Başarı/Onay: Yeşil */
        .bg-dark-card { background-color: #1f2937; } /* Kart Arka Planı: Koyu Gri/Lacivert */
        
        .slot-card {
            transition: transform 0.2s, box-shadow 0.2s;
            cursor: default; 
            border: 2px solid #374151; 
            min-height: 350px; 
            display: flex;
            flex-direction: column;
            justify-content: space-between; 
            position: relative; 
            margin-top: 1.5rem; 
        }
        .slot-card:not(.reserved) {
            cursor: pointer;
        }
        .slot-card:hover:not(.reserved) {
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(239, 68, 68, 0.3); /* Kırmızı Gölge */
        }

        .reserved {
            background-color: #111827;
            opacity: 1;
        }
        
        .modal {
            background-color: rgba(0, 0, 0, 0.85);
            backdrop-filter: blur(5px);
        }
        .console-box {
            background-color: #030712;
            border-top: 2px solid #ef4444; 
            max-height: 200px;
            overflow-y: scroll;
        }
        #header-title {
            text-shadow: 0 0 10px #ef4444;
        }
        .description-box {
            max-height: 120px; 
            overflow-y: auto;
            white-space: pre-wrap; 
        }
        .description-box::-webkit-scrollbar {
            width: 6px;
        }
        .description-box::-webkit-scrollbar-thumb {
            background-color: #4b5563;
            border-radius: 3px;
        }
        .description-box::-webkit-scrollbar-track {
            background-color: #1f2937;
        }

        .manager-delete-button {
            position: absolute;
            top: -1.25rem; 
            right: 0;
            z-index: 10;
        }

        #slots-container > div {
            position: relative;
        }

    </style>
</head>
<body class="p-4 sm:p-8">

    <div id="app" class="max-w-7xl mx-auto">
        
        <!-- Başlık ve Zaman -->
        <header class="text-center mb-10">
            <h1 id="header-title" class="text-6xl sm:text-7xl font-black text-custom-red tracking-wider mb-2">
                ZERON ORGANİZASYON
            </h1>
            <p id="current-time" class="text-lg text-gray-400 font-bold">Yükleniyor...</p>
        </header>

        <!-- Ana Başlık -->
        <h2 class="text-4xl sm:text-5xl text-center font-extrabold mb-12 py-4 bg-dark-card rounded-xl shadow-2xl"
            style="border: 1px solid #ef4444;">
            OYUNCUYA İHTİYACI OLAN TAKIMLAR
        </h2>

        <!-- Kullanıcı ID Bilgisi (Yönetici Modu Gizli) -->
        <div id="auth-info" class="text-sm text-center mb-6 p-3 rounded-lg bg-dark-card border border-gray-600">
            <!-- Auth durumu JS tarafından sadece Kullanıcı ID'si ile doldurulacak -->
        </div>

        <!-- Kurallar ve Bilgilendirme -->
        <div class="mb-12 p-6 bg-dark-card rounded-xl border border-custom-red shadow-lg">
            <h3 class="text-2xl font-bold text-custom-red mb-4">REZERVASYON KURALLARI VE BİLGİLENDİRME</h3>
            <ul class="list-disc list-inside space-y-2 text-gray-300 ml-4">
                <li>Rezervasyonlar Takım İsmi, Instagram ve Açıklama girilerek yapılır.</li>
                <li>Herkes sadece günde bir kez rezervasyon yapabilir (Limit tarayıcı bazlıdır).</li>
            </ul>
        </div>
        
        <!-- Slotlar Alanı (lg:grid-cols-4 ile daha büyük kartlar) -->
        <div id="slots-container" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6">
            <!-- Slot Kartları JS tarafından buraya eklenecek -->
            <div id="loading" class="col-span-full text-center text-xl p-10 text-custom-green">
                Slotlar yükleniyor... Lütfen bekleyin.
            </div>
        </div>

        <!-- Konsol Kutusu -->
        <div class="mt-12">
            <h3 class="text-xl font-bold text-gray-400 mb-2">Konsol (Hata Ayıklama)</h3>
            <div id="console" class="console-box p-4 text-xs text-gray-200 rounded-lg whitespace-pre-wrap">
                Hazırlanıyor...
            </div>
        </div>
    </div>

    <!-- Modal (Genel Onay/Uyarı Penceresi) -->
    <div id="modal" class="modal fixed inset-0 flex items-center justify-center z-50 hidden">
        <div class="bg-dark-card p-6 rounded-xl w-11/12 max-w-lg shadow-2xl border border-custom-red">
            <h3 id="modal-title" class="text-2xl font-bold text-custom-green mb-4">Onay</h3>
            <p id="modal-message" class="text-gray-300 mb-6">Slotu rezerve etmek istediğinizden emin misiniz?</p>
            <div class="flex justify-end space-x-4">
                <button id="modal-cancel" class="px-4 py-2 bg-gray-600 hover:bg-gray-700 text-white font-bold rounded-lg transition duration-200">
                    İptal
                </button>
                <button id="modal-confirm" class="px-4 py-2 bg-custom-red hover:bg-red-700 text-white font-bold rounded-lg transition duration-200">
                    Evet, Rezerv Et
                </button>
            </div>
        </div>
    </div>

    <!-- Input Modal (Rezervasyon Formu) -->
    <div id="input-modal" class="modal fixed inset-0 flex items-center justify-center z-50 hidden">
        <div class="bg-dark-card p-8 rounded-xl w-11/12 max-w-xl shadow-2xl border border-custom-red">
            <h3 class="text-3xl font-bold text-custom-red mb-6">Slot Rezervasyonu: <span id="input-modal-slotid" class="text-custom-green"></span></h3>
            
            <div class="space-y-4">
                <div>
                    <label for="team-name" class="block text-sm font-medium text-gray-400 mb-1">Takım İsmi</label>
                    <input type="text" id="team-name" placeholder="Örn: Fire Dragons, Zeron Esport" maxlength="50"
                           class="w-full p-3 bg-gray-700 border border-gray-600 rounded-lg text-white focus:ring-custom-red focus:border-custom-red" required>
                </div>
                <div>
                    <label for="instagram-username" class="block text-sm font-medium text-gray-400 mb-1">Instagram Kullanıcı Adı</label>
                    <input type="text" id="instagram-username" placeholder="@kullanici_adiniz" maxlength="30"
                           class="w-full p-3 bg-gray-700 border border-gray-600 rounded-lg text-white focus:ring-custom-red focus:border-custom-red" required>
                </div>
                <div>
                    <label for="description" class="block text-sm font-medium text-gray-400 mb-1">Açıklama (İhtiyaçlarınızı ve Beklentilerinizi yazın)</label>
                    <textarea id="description" rows="5" placeholder="Örn: 1 adet JGL, 1 adet MID arıyoruz. Discord zorunlu..." 
                              class="w-full p-3 bg-gray-700 border border-gray-600 rounded-lg text-white focus:ring-custom-red focus:border-custom-red resize-y"></textarea>
                </div>
                <p id="input-error" class="text-custom-red text-sm hidden">Lütfen zorunlu alanları doldurun.</p>
            </div>

            <div class="flex justify-end space-x-4 mt-6">
                <button id="input-modal-cancel" class="px-4 py-2 bg-gray-600 hover:bg-gray-700 text-white font-bold rounded-lg transition duration-200">
                    İptal
                </button>
                <button id="input-modal-submit" class="px-4 py-2 bg-custom-red hover:bg-red-700 text-white font-bold rounded-lg transition duration-200">
                    Slotu Rezerv Et
                </button>
            </div>
        </div>
    </div>


    <!-- Firebase Script'leri -->
    <script type="module">
        // Firebase SDK modül importları
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { 
            getAuth, 
            signInAnonymously, 
            signInWithCustomToken, 
            onAuthStateChanged
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        // setLogLevel import'u için Firestore SDK'dan kaldırıldı, çünkü o genel bir modül import'u değil.
        import { 
            getFirestore, 
            doc, 
            setDoc, 
            onSnapshot, 
            collection, 
            getDoc,
            serverTimestamp
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Firebase log level ayarı için ayrı bir import gerekebilir.
        // setLogLevel fonksiyonu, Firebase'in ana paketinde veya özel bir modülünde yer alır.
        // Hata ayıklama için geçici olarak console.log'u kullanmaya devam ediyoruz.
        // setLogLevel('debug'); 
        
        // Global Değişkenler
        let app, db, auth;
        let userId = '';
        let isManager = false;
        const SLOT_COUNT = 10;
        const COLLECTION_PATH = 'public/data/slots'; 
        const INSTAGRAM_URL = 'https://instagram.com/';

        // --- GÜNCELLEME: GitHub Pages için Firebase Yapılandırması (Kullanıcının verdiği verilerle dolduruldu) ---
        const MANUAL_FIREBASE_CONFIG = {
            apiKey: "AIzaSyDoHXM6Bjx29oWr-pA8fI1sQS0fI6E_Oao",
            authDomain: "zeronn-free-agent.firebaseapp.com",
            projectId: "zeronn-free-agent", 
            storageBucket: "zeronn-free-agent.firebasestorage.app",
            messagingSenderId: "812254200632",
            appId: "1:812254200632:web:324ae8f37de81e7eafb7cd" 
        };

        // Canvas Ortamı Değişkenlerini Tanımla (GitHub'da bunlar null/tanımsız olacaktır)
        const appId = typeof __app_id !== 'undefined' ? __app_id : MANUAL_FIREBASE_CONFIG.projectId;
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : MANUAL_FIREBASE_CONFIG;
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null; 
        
        
        // DOM Elementleri
        const consoleEl = document.getElementById('console');
        const authInfoEl = document.getElementById('auth-info');
        const slotsContainer = document.getElementById('slots-container');
        const loadingEl = document.getElementById('loading');
        const currentTimeEl = document.getElementById('current-time');
        const inputModalEl = document.getElementById('input-modal');
        const inputErrorEl = document.getElementById('input-error');

        // --- Yardımcı Fonksiyonlar ---

        function logToConsole(message, type = 'INFO') {
            const timestamp = new Date().toLocaleTimeString('tr-TR');
            const logEntry = `[${timestamp}] [${type}] ${message}\n`;
            console.log(`[${type}] ${message}`); 
            consoleEl.textContent += logEntry;
            consoleEl.scrollTop = consoleEl.scrollHeight;
        }

        function updateTime() {
            const now = new Date();
            const options = { 
                weekday: 'long', 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric', 
                hour: '2-digit', 
                minute: '2-digit', 
                second: '2-digit', 
                timeZone: 'Europe/Istanbul', 
                timeZoneName: 'short' 
            };
            currentTimeEl.textContent = "Güncel TR Saati: " + now.toLocaleDateString('tr-TR', options);
        }

        // Custom Modal (Genel Onay/Uyarı Penceresi)
        function showModal(title, message, isConfirmation = false, confirmText = 'Evet, Rezerv Et') {
            return new Promise(resolve => {
                const modalEl = document.getElementById('modal');
                const modalTitleEl = document.getElementById('modal-title');
                const modalMessageEl = document.getElementById('modal-message');
                const confirmBtn = document.getElementById('modal-confirm');
                const cancelBtn = document.getElementById('modal-cancel');

                modalTitleEl.textContent = title;
                modalMessageEl.textContent = message;

                if (isConfirmation) {
                    confirmBtn.style.display = 'inline-block';
                    cancelBtn.style.display = 'inline-block';
                    confirmBtn.textContent = confirmText;
                    
                    if (confirmText.includes("SİL")) {
                        confirmBtn.className = 'px-4 py-2 bg-custom-red hover:bg-red-700 text-white font-bold rounded-lg transition duration-200';
                        modalTitleEl.classList.remove('text-custom-green');
                        modalTitleEl.classList.add('text-custom-red');
                    } else {
                        confirmBtn.className = 'px-4 py-2 bg-custom-green hover:bg-green-700 text-white font-bold rounded-lg transition duration-200';
                        modalTitleEl.classList.remove('text-custom-red');
                        modalTitleEl.classList.add('text-custom-green');
                    }
                    cancelBtn.textContent = 'İptal';
                } else {
                    confirmBtn.style.display = 'none';
                    cancelBtn.style.display = 'inline-block';
                    cancelBtn.textContent = 'Kapat';
                    modalTitleEl.classList.remove('text-custom-green');
                    modalTitleEl.classList.add('text-custom-red');
                }

                const handleConfirm = () => {
                    modalEl.classList.add('hidden');
                    confirmBtn.removeEventListener('click', handleConfirm);
                    cancelBtn.removeEventListener('click', handleCancel);
                    resolve(true);
                };

                const handleCancel = () => {
                    modalEl.classList.add('hidden');
                    confirmBtn.removeEventListener('click', handleConfirm);
                    cancelBtn.removeEventListener('click', handleCancel);
                    resolve(false);
                };

                if (isConfirmation) {
                    confirmBtn.addEventListener('click', handleConfirm);
                }
                cancelBtn.addEventListener('click', handleCancel);
                
                modalEl.classList.remove('hidden');
            });
        }

        // Input Modal (Form) gösterimi
        function showInputModal(slotId) {
            return new Promise(resolve => {
                document.getElementById('input-modal-slotid').textContent = slotId;
                const teamNameInput = document.getElementById('team-name');
                const instagramInput = document.getElementById('instagram-username');
                const descriptionInput = document.getElementById('description');
                const submitBtn = document.getElementById('input-modal-submit');
                const cancelBtn = document.getElementById('input-modal-cancel');
                
                teamNameInput.value = '';
                instagramInput.value = '';
                descriptionInput.value = '';
                inputErrorEl.classList.add('hidden');

                const handleSubmit = () => {
                    const teamName = teamNameInput.value.trim();
                    const instagram = instagramInput.value.trim().replace(/^@/, ''); 
                    const description = descriptionInput.value.trim();

                    if (!teamName || !instagram) {
                        inputErrorEl.textContent = 'Takım İsmi ve Instagram Kullanıcı Adı zorunludur.';
                        inputErrorEl.classList.remove('hidden');
                        return;
                    }

                    inputModalEl.classList.add('hidden');
                    submitBtn.removeEventListener('click', handleSubmit);
                    cancelBtn.removeEventListener('click', handleCancel);
                    
                    resolve({ teamName, instagram, description });
                };

                const handleCancel = () => {
                    inputModalEl.classList.add('hidden');
                    submitBtn.removeEventListener('click', handleSubmit);
                    cancelBtn.removeEventListener('click', handleCancel);
                    resolve(null);
                };

                submitBtn.addEventListener('click', handleSubmit);
                cancelBtn.addEventListener('click', handleCancel);
                
                inputModalEl.classList.remove('hidden');
                teamNameInput.focus();
            });
        }

        // --- Firebase ve Uygulama Mantığı ---

        async function initializeFirebase() {
            logToConsole("Firebase başlangıç kontrolü...");
            
            // Yapılandırma eksikse, HATA mesajını göster.
            if (!firebaseConfig.apiKey) {
                const errorMessage = "KRİTİK HATA: Firebase yapılandırması eksik. Lütfen `index.html` dosyasındaki `MANUAL_FIREBASE_CONFIG` değişkenini kendi proje bilgilerinizle doldurun.";
                logToConsole(errorMessage, 'FATAL ERROR');
                slotsContainer.innerHTML = `<div class="col-span-full text-center text-2xl p-10 text-custom-red">${errorMessage}</div>`;
                return false;
            }

            try {
                logToConsole(`Firebase Proje ID: ${firebaseConfig.projectId}`);
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                logToConsole("Firebase Uygulaması ve Firestore Başlatıldı. Kimlik Doğrulama bekleniyor...");

                // Kimlik Doğrulama: Canvas'ta token ile, GitHub'da anonim
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                    logToConsole("Custom Token ile giriş başarılı (Canvas/Yönetici modu).");
                } else {
                    await signInAnonymously(auth);
                    logToConsole("Anonim giriş başlatıldı (GitHub/Halka Açık mod).");
                }

                await new Promise(resolve => {
                    const unsubscribe = onAuthStateChanged(auth, (user) => {
                        if (user) {
                            userId = user.uid;
                            isManager = !!initialAuthToken; 
                            logToConsole(`Oturum Açma Tamamlandı. Kullanıcı ID: ${userId} (Yönetici: ${isManager ? 'EVET' : 'HAYIR'})`);
                            
                            authInfoEl.innerHTML = `
                                Kullanıcı ID: <span class="text-custom-green font-mono break-all">${userId}</span> 
                            `;
                            unsubscribe(); 
                            resolve();
                        } else {
                            logToConsole("HATA: Oturum açılamadı veya kullanıcı yok. Firebase Auth sorununu kontrol edin.", 'AUTH ERROR');
                            // Anonim giriş başarısız olursa, bir süre sonra bu tekrar tetiklenir.
                        }
                    }, (error) => {
                        logToConsole(`onAuthStateChanged Hata: ${error.message}`, 'AUTH ERROR');
                    });
                });

                return true;
            } catch (error) {
                logToConsole(`Firebase KRİTİK Başlatma Hatası (Yapılandırma Hatası Olabilir): ${error.message}`, 'FATAL ERROR');
                showModal('Kritik Hata', `Firebase hizmetlerine bağlanırken bir sorun oluştu: ${error.message}. Konsolu ve yapılandırma bilgilerinizi kontrol edin.`, false);
                return false;
            }
        }

        // Slot verilerini Firestore'dan oku (Canlı Dinleme)
        function listenForSlots() {
            if (!db || !userId) {
                 logToConsole("Veritabanı veya Kullanıcı ID'si hazır değil. Dinleme başlatılamadı.", 'WARN');
                 return;
            }

            // GitHub Pages'tan erişim için public yolu KULLANILMALIDIR.
            const fullCollectionPath = `artifacts/${appId}/${COLLECTION_PATH}`; 
            const slotsRef = collection(db, fullCollectionPath);
            logToConsole(`Firestore Dinleniyor... Yol: ${fullCollectionPath}`);

            onSnapshot(slotsRef, (snapshot) => {
                loadingEl?.remove();
                
                const slotsData = {};
                snapshot.docs.forEach(doc => {
                    slotsData[doc.id] = doc.data();
                });
                
                logToConsole(`Veri alındı: ${snapshot.size} slot bulundu.`, 'INFO');
                renderSlots(slotsData);

            }, (error) => {
                // İzin (Rules) hatası burada yakalanır - GitHub'daki en yaygın hata budur.
                logToConsole(`Firestore Dinleme HATASI (Erişim İzni Olabilir): ${error.message}. Güvenlik kurallarınızı kontrol edin!`, 'PERM ERROR');
                showModal('Veritabanı Erişimi Hatası', `Verileri okuyamıyorum. Hata: ${error.message}. Firebase Güvenlik Kurallarınızı (Rules) kontrol edin.`, false);
            });
        }

        // Slotları ekranda göster
        function renderSlots(data) {
            slotsContainer.innerHTML = ''; 
            
            const sortedSlotIds = Object.keys(data).sort((a, b) => {
                const numA = parseInt(a.replace('SLOT_', ''), 10);
                const numB = parseInt(b.replace('SLOT_', ''), 10);
                return numA - numB;
            });

            for (let i = 1; i <= SLOT_COUNT; i++) {
                const slotId = `SLOT_${i}`;
                const slotData = data[slotId];
                const isReserved = slotData && slotData.reservedBy !== null;
                
                let cardClass = isReserved ? 'reserved' : 'hover:bg-dark-card/70';
                
                const slotWrapper = document.createElement('div');
                slotWrapper.className = 'relative'; 

                const slotEl = document.createElement('div');
                slotEl.id = slotId;
                slotEl.className = `slot-card bg-dark-card p-6 rounded-xl shadow-lg border-2 ${cardClass}`;
                
                
                if (isReserved) {
                    const teamName = slotData.teamName || 'Bilinmeyen Takım';
                    const instagram = slotData.instagram || 'Yok';
                    const description = slotData.description || 'Açıklama girilmemiş.';
                    
                    let reservationTime = 'Bilinmiyor';
                    if (slotData?.timestamp?.toDate) {
                        reservationTime = slotData.timestamp.toDate().toLocaleTimeString('tr-TR', { timeZone: 'Europe/Istanbul' });
                    }

                    // Yönetici Silme Butonu 
                    if (isReserved && isManager) {
                        const deleteButton = document.createElement('button');
                        deleteButton.className = 'manager-delete-button p-2 bg-custom-red hover:bg-red-700 text-white rounded-lg text-xs font-bold shadow-xl transition duration-200 flex items-center justify-center';
                        deleteButton.innerHTML = `<svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>SİL`;
                        deleteButton.title = `${slotId} Rezervasyonunu Sil (Yönetici)`;
                        deleteButton.addEventListener('click', (e) => {
                            e.stopPropagation(); 
                            window.handleSlotDeletion(slotId); // Global fonksiyonu çağır
                        });
                        slotWrapper.appendChild(deleteButton); 
                    }


                    // Rezerve Edilmiş Slot İçeriği
                    slotEl.innerHTML = `
                        <div class="flex flex-col h-full">
                            <h4 class="text-4xl font-black mb-1 text-custom-red tracking-wide">${teamName}</h4>
                            <p class="text-xs text-gray-500 mb-4">Slot ID: ${slotId.replace('_', ' ')}</p>
                            
                            <!-- Instagram Linki -->
                            <div class="mb-4 flex items-center">
                                <span class="text-sm font-semibold text-gray-400 mr-2">IG:</span>
                                <a href="${INSTAGRAM_URL}${instagram}" target="_blank" class="text-custom-green hover:underline font-mono text-lg transition duration-200 flex items-center" onclick="event.stopPropagation()">
                                    @${instagram}
                                    <svg class="w-4 h-4 ml-1" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4m-4-7a2 2 0 11-4 0 2 2 0 014 0zM17 7L5 19"></path></svg>
                                </a>
                            </div>

                            <!-- Açıklama Kutusu -->
                            <div class="flex-grow mb-4 bg-custom-red-light p-3 rounded-lg border border-custom-red overflow-hidden">
                                <p class="text-sm font-bold text-custom-red mb-1">Açıklama:</p>
                                <div class="description-box text-gray-200 text-sm">
                                    ${description}
                                </div>
                            </div>

                            <!-- Durum Alanı -->
                            <div>
                                <button class="reserve-button w-full mt-3 py-3 rounded-lg text-sm bg-gray-700/50 text-custom-red font-bold" disabled>
                                    DOLU - ${reservationTime}
                                </button>
                            </div>
                        </div>
                    `;
                } else {
                    // Boş Slot İçeriği
                    slotEl.innerHTML = `
                        <div class="flex flex-col h-full justify-between">
                            <div>
                                <h4 class="text-4xl font-extrabold mb-3 text-custom-red">${slotId.replace('_', ' ')}</h4>
                                <p class="text-gray-400 text-sm mb-4 status-text">Takımınız İçin Slotu Rezerv Edin</p>
                                <div class="h-32"></div> 
                            </div>
                            <button class="reserve-button w-full py-3 rounded-lg transition duration-200 text-base bg-custom-green hover:bg-green-700 text-white font-bold">
                                BOŞ - HEMEN KAP!
                            </button>
                        </div>
                    `;
                    
                    slotEl.addEventListener('click', () => {
                        handleSlotReservation(slotId);
                    });
                }
                
                slotWrapper.appendChild(slotEl);
                slotsContainer.appendChild(slotWrapper);
            }
        }

        // Rezervasyon işlemini yönet
        async function handleSlotReservation(slotId) {
            const docRef = doc(db, `artifacts/${appId}/${COLLECTION_PATH}/${slotId}`);
            try {
                const docSnap = await getDoc(docRef);
                if (docSnap.exists() && docSnap.data().reservedBy !== null) {
                    logToConsole("Slot dolu, rezervasyon yapılamaz.", 'WARN');
                    return; 
                }
            } catch (error) {
                 logToConsole(`Slot durumu kontrolü başarısız: ${error.message}`, 'ERROR');
                 showModal('Hata', 'Slotun müsaitliğini kontrol ederken bir sorun oluştu. Konsolu kontrol edin.', false);
                 return;
            }


            if (!userId) {
                showModal('Hata', 'Kullanıcı yetkilendirmesi hazır değil. Lütfen bekleyin.', false);
                return;
            }

            // Normal Kullanıcı Kontrolü (Limit kontrolü)
            if (!isManager) {
                try {
                    const hasReservedToday = await checkDailyReservationLimit();
                    
                    if (hasReservedToday) {
                        showModal('Uyarı', 'Günlük limitinizi doldurdunuz. Günde sadece bir kez rezervasyon yapabilirsiniz.', false);
                        return;
                    }
                } catch (error) {
                    logToConsole(`Limit Kontrol Hatası: ${error.message}`, 'ERROR');
                    showModal('Hata', 'Limit kontrolü sırasında bir sorun oluştu.', false);
                    return;
                }
            } else {
                 logToConsole("Yönetici: Limit kontrolü atlanıyor.", 'DEBUG');
            }


            // Formu göster ve verileri al
            const formData = await showInputModal(slotId);
            
            if (formData) {
                reserveSlot(slotId, formData);
            }
        }

        // Kullanıcının bugün rezervasyon yapıp yapmadığını kontrol et
        async function checkDailyReservationLimit() {
            const lastReservationDate = localStorage.getItem('lastReservationDate');
            if (!lastReservationDate) return false;

            const today = new Date().toLocaleDateString('tr-TR', { timeZone: 'Europe/Istanbul' });
            return lastReservationDate === today;
        }

        // Slotu rezerve etme işlemi
        async function reserveSlot(slotId, formData) {
            const slotDocRef = doc(db, `artifacts/${appId}/${COLLECTION_PATH}/${slotId}`);
            
            try {
                const reservationData = {
                    reservedBy: userId,
                    timestamp: serverTimestamp(),
                    teamName: formData.teamName,
                    instagram: formData.instagram,
                    description: formData.description,
                    isManager: isManager 
                };
                
                await setDoc(slotDocRef, reservationData);
                
                if (!isManager) {
                    localStorage.setItem('lastReservationDate', new Date().toLocaleDateString('tr-TR', { timeZone: 'Europe/Istanbul' }));
                }
                
                logToConsole(`${slotId} başarılı bir şekilde rezerve edildi. Takım: ${formData.teamName}`, 'SUCCESS');
                showModal('Başarılı!', `${slotId} slotunu başarıyla rezerve ettiniz. Bilgileriniz sitede görünüyor.`, false);

            } catch (error) {
                logToConsole(`Rezervasyon Hatası: ${error.message}`, 'ERROR');
                showModal('Hata', `Rezervasyon işlemi başarısız oldu: ${error.message}. Konsolu kontrol edin.`, false);
            }
        }

        // --- YÖNETİCİ MODU: Slot Silme İşlemi ---
        window.handleSlotDeletion = async function(slotId) {
            if (!isManager) {
                 showModal('Yetki Hatası', 'Bu işlemi sadece yöneticiler yapabilir.', false);
                 return;
            }
            logToConsole(`Yönetici: ${slotId} silme işlemi başlatıldı.`, 'DEBUG');
            
            const confirmed = await showModal(
                'Yönetici Onayı',
                `${slotId} slotundaki rezervasyonu kalıcı olarak SİLMEK istediğinizden emin misiniz? Bu işlem geri alınamaz.`, 
                true,
                'EVET, REZERVASYONU SİL'
            );
            
            if (confirmed) {
                const slotDocRef = doc(db, `artifacts/${appId}/${COLLECTION_PATH}/${slotId}`);
                
                try {
                    // Slotu sıfırla
                    const deletionData = {
                        reservedBy: null, 
                        timestamp: null,  
                        teamName: null,
                        instagram: null,
                        description: null,
                        isManager: false 
                    };
                    
                    await setDoc(slotDocRef, deletionData);
                    
                    logToConsole(`${slotId} slotundaki rezervasyon YÖNETİCİ tarafından silindi.`, 'SUCCESS');
                    showModal('Silindi!', `${slotId} slotu başarıyla temizlendi ve kullanıma açıldı.`, false);

                } catch (error) {
                    logToConsole(`Silme Hatası: ${error.message}`, 'ERROR');
                    showModal('Hata', `Rezervasyon silme işlemi başarısız oldu: ${error.message}.`, false);
                }
            }
        }
        
        // --- Başlangıç ---
        window.onload = async () => {
            updateTime();
            setInterval(updateTime, 1000); // Her saniye saati güncelle

            if (await initializeFirebase()) {
                
                // Başlangıçta slotların varlığını kontrol et ve yoksa oluştur
                const fullPath = `artifacts/${appId}/${COLLECTION_PATH}/SLOT_1`;
                const initialSlotRef = doc(db, fullPath);
                
                try {
                    const docSnap = await getDoc(initialSlotRef);
                
                    if (!docSnap.exists() || !docSnap.data() || docSnap.data().reservedBy === undefined) { 
                        logToConsole("Slot verileri Firestore'da bulunamadı veya boş. Başlangıç slotları oluşturuluyor...");
                        for (let i = 1; i <= SLOT_COUNT; i++) {
                            const slotId = `SLOT_${i}`;
                            const slotDocRef = doc(db, `artifacts/${appId}/${COLLECTION_PATH}/${slotId}`);
                            await setDoc(slotDocRef, {
                                reservedBy: null,
                                timestamp: null,
                                teamName: null,
                                instagram: null,
                                description: null,
                                isManager: false
                            });
                        }
                        logToConsole("Başlangıç slotları oluşturuldu.");
                    } else {
                        logToConsole("Slot verileri bulundu, oluşturma adımı atlandı.");
                    }
                } catch (error) {
                    logToConsole(`Başlangıç Slot Oluşturma/Kontrol Hatası: ${error.message}`, 'FATAL ERROR');
                    showModal('Veritabanı Başlangıç Hatası', `Slotları kontrol ederken kritik bir hata oluştu: ${error.message}. Kuralları veya yapılandırmayı kontrol edin.`, false);
                    return;
                }

                listenForSlots();
            }
        };

    </script>
</body>
</html>
